package com.revworkforce.service;

import java.sql.Date;

import com.revworkforce.dao.EmployeeDAO;
import com.revworkforce.model.Employee;
import com.revworkforce.util.DOBValidator;
import com.revworkforce.util.EmailValidator;
import com.revworkforce.util.PasswordGenerator;
import com.revworkforce.util.PasswordValidator;

public class EmployeeService {

    private EmployeeDAO dao = new EmployeeDAO();
    public Employee login(int empId, String password) throws Exception {

        Employee emp = dao.login(empId, password);

        if (emp == null)
            throw new Exception("Invalid Employee ID or Password");

        if (!"ACTIVE".equalsIgnoreCase(emp.getStatus()))
            throw new Exception("Account inactive");

        return emp;
    }

    public void changePassword(int empId,
                               String newPwd,
                               String confirmPwd) throws Exception {

        if (!newPwd.equals(confirmPwd))
            throw new Exception("Passwords do not match");

        PasswordValidator.validate(newPwd);

        if (dao.isPasswordUsedBefore(empId, newPwd)) {
            throw new Exception("You cannot reuse an old password");
        }

        dao.updatePassword(empId, newPwd);
        dao.savePasswordHistory(empId, newPwd);

        System.out.println("Password changed successfully");
    }

    public void addEmployee(String name,
                            String email,
                            Date dob) throws Exception {

        EmailValidator.validate(email);
        DOBValidator.validate(dob);

        String tempPwd = PasswordGenerator.generateTempPassword();
        int empId = dao.addEmployee(name, email, dob, tempPwd);

        System.out.println("\n--- Employee Created ---");
        System.out.println("Employee ID   : " + empId);
        System.out.println("Temp Password : " + tempPwd);
    }
    public void forgotPasswordWithSecurity(int empId,
                                           String ans1,
                                           String ans2) throws Exception {

        boolean valid =
            dao.validateSecurityAnswers(empId, ans1, ans2);

        if (!valid)
            throw new Exception("Security answers incorrect");

        String tempPwd =
            PasswordGenerator.generateTempPassword();

        dao.resetPassword(empId, tempPwd);
        dao.savePasswordHistory(empId, tempPwd);

        System.out.println("\n--- Password Reset Successful ---");
        System.out.println("Temporary Password: " + tempPwd);
    }
}
