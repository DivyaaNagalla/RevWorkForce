package com.revworkforce.dao;

import java.sql.PreparedStatement;
import java.sql.ResultSet;

import com.revworkforce.util.DBUtil;

public class NotificationDAO {

    public int getUnreadCount(int empId) throws Exception {

        String sql =
            "SELECT COUNT(*) FROM NOTIFICATION " +
            "WHERE EMP_ID=? AND IS_READ='N'";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, empId);
        ResultSet rs = ps.executeQuery();
        rs.next();
        return rs.getInt(1);
    }

    public void viewNotifications(int empId) throws Exception {

        String sql =
            "SELECT NOTIF_ID, MESSAGE " +
            "FROM NOTIFICATION " +
            "WHERE EMP_ID=? " +
            "ORDER BY CREATED_DATE DESC";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, empId);
        ResultSet rs = ps.executeQuery();

        System.out.println("\n--- Notifications ---");

        boolean found = false;

        while (rs.next()) {
            found = true;
            System.out.println(
                rs.getInt("NOTIF_ID") + " : " +
                rs.getString("MESSAGE"));
        }

        if (!found) {
            System.out.println("No notifications");
        }
        String update =
            "UPDATE NOTIFICATION SET IS_READ='Y' WHERE EMP_ID=?";

        PreparedStatement ps2 =
            DBUtil.getConnection().prepareStatement(update);

        ps2.setInt(1, empId);
        ps2.executeUpdate();
    }
}
