package com.revworkforce.dao;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Date;

import com.revworkforce.util.DBUtil;

public class LeaveDAO {

    public void applyLeave(int empId,
                           int leaveTypeId,
                           Date startDate,
                           Date endDate,
                           String reason) throws Exception {

        String sql =
            "INSERT INTO LEAVE_APPLICATION " +
            "(LEAVE_ID, EMP_ID, LEAVE_TYPE_ID, START_DATE, END_DATE, REASON, STATUS, APPLIED_DATE) " +
            "VALUES (LEAVE_APP_SEQ.NEXTVAL, ?, ?, ?, ?, ?, 'PENDING', SYSDATE)";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, empId);
        ps.setInt(2, leaveTypeId);
        ps.setDate(3, startDate);
        ps.setDate(4, endDate);
        ps.setString(5, reason);

        ps.executeUpdate();
    }
    public ResultSet viewMyLeaves(int empId) throws Exception {

        String sql =
            "SELECT LEAVE_ID, START_DATE, END_DATE, STATUS " +
            "FROM LEAVE_APPLICATION " +
            "WHERE EMP_ID = ? " +
            "ORDER BY APPLIED_DATE DESC";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, empId);
        return ps.executeQuery();
    }
    public void cancelLeave(int leaveId) throws Exception {

        String sql =
            "UPDATE LEAVE_APPLICATION " +
            "SET STATUS='CANCELLED' " +
            "WHERE LEAVE_ID=? AND STATUS='PENDING'";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, leaveId);
        ps.executeUpdate();
    }
    public ResultSet viewTeamLeaves(int managerId) throws Exception {

        String sql =
            "SELECT L.LEAVE_ID, E.NAME, L.START_DATE, L.END_DATE, L.STATUS " +
            "FROM LEAVE_APPLICATION L " +
            "JOIN EMPLOYEE E ON L.EMP_ID = E.EMP_ID " +
            "WHERE E.MANAGER_ID = ? " +
            "ORDER BY L.APPLIED_DATE DESC";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, managerId);
        return ps.executeQuery();
    }
    public void updateLeaveStatus(int leaveId,
                                  String status,
                                  String comment) throws Exception {

        String sql =
            "UPDATE LEAVE_APPLICATION " +
            "SET STATUS=?, MANAGER_COMMENT=? " +
            "WHERE LEAVE_ID=?";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setString(1, status);
        ps.setString(2, comment);
        ps.setInt(3, leaveId);

        ps.executeUpdate();
    }
}
