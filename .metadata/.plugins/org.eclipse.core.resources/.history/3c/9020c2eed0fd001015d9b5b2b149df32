package com.revworkforce.service;

import java.sql.Date;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.revworkforce.dao.EmployeeDAO;
import com.revworkforce.model.Employee;
import com.revworkforce.util.PasswordGenerator;
import com.revworkforce.util.PasswordValidator;

public class EmployeeService {

    private static final Logger logger =
            LoggerFactory.getLogger(EmployeeService.class);

    private EmployeeDAO dao;

    // ðŸ”¹ Default constructor (used by UI)
    public EmployeeService() {
        this.dao = new EmployeeDAO();
        logger.info("EmployeeService initialized using default constructor");
    }

    // ðŸ”¹ Constructor for Unit Testing (Mockito)
    public EmployeeService(EmployeeDAO dao) {
        this.dao = dao;
        logger.info("EmployeeService initialized using injected EmployeeDAO");
    }

    // ================= LOGIN =================

    public Employee login(int empId, String password) throws Exception {

        logger.info("Login attempt for empId={}", empId);

        Employee emp = dao.login(empId, password);

        if (emp == null) {
            logger.warn("Login failed for empId={} : invalid credentials", empId);
            throw new Exception("Invalid Employee ID or Password");
        }

        if (!"ACTIVE".equalsIgnoreCase(emp.getStatus())) {
            logger.warn("Login blocked for empId={} : account inactive", empId);
            throw new Exception("Account inactive");
        }

        logger.info("Login successful for empId={}", empId);
        return emp;
    }

    // ================= CHANGE PASSWORD =================

    public void changePassword(int empId,
                               String newPwd,
                               String confirmPwd) throws Exception {

        logger.info("Password change request for empId={}", empId);

        if (!newPwd.equals(confirmPwd)) {
            logger.warn("Password mismatch for empId={}", empId);
            throw new Exception("Passwords do not match");
        }

        PasswordValidator.validate(newPwd);

        if (dao.isPasswordUsedBefore(empId, newPwd)) {
            logger.warn("Password reuse attempt for empId={}", empId);
            throw new Exception("You cannot reuse an old password");
        }

        dao.updatePassword(empId, newPwd);
        dao.savePasswordHistory(empId, newPwd);

        logger.info("Password changed successfully for empId={}", empId);
    }

    // ================= ADD EMPLOYEE =================

    public void addEmployee(String name,
                            String email,
                            Date dob) throws Exception {

        logger.info("Add employee request: name={}, email={}", name, email);

        String tempPwd = PasswordGenerator.generateTempPassword();
        int empId = dao.addEmployee(name, email, dob, tempPwd);

        logger.info("Employee created successfully empId={}, tempPwdGenerated=true", empId);
    }

    // ================= ASSIGN MANAGER =================

    public void assignManager(int empId, int managerId) throws Exception {
        logger.info("Assigning managerId={} to empId={}", managerId, empId);
        dao.assignManager(empId, managerId);
        logger.info("Manager assigned successfully for empId={}", empId);
    }

    // ================= UPDATE PROFILE =================

    public Employee updateProfile(int empId,
                                  String phone,
                                  String address,
                                  String emergency) throws Exception {

        logger.info("Update profile request for empId={}", empId);

        if (phone == null || !phone.matches("\\d{10}")) {
            logger.warn("Invalid phone number for empId={}", empId);
            throw new Exception("Invalid phone number");
        }

        if (emergency == null || !emergency.matches("\\d{10}")) {
            logger.warn("Invalid emergency contact for empId={}", empId);
            throw new Exception("Invalid emergency contact number");
        }

        if (address == null || address.trim().isEmpty()) {
            logger.warn("Empty address for empId={}", empId);
            throw new Exception("Address cannot be empty");
        }

        dao.updateProfile(empId, phone, address, emergency);
        logger.info("Profile updated successfully for empId={}", empId);

        return dao.getEmployeeById(empId);
    }

    // ================= FORGOT PASSWORD =================

    public void forgotPasswordWithSecurity(int empId,
                                           String ans1,
                                           String ans2) throws Exception {

        logger.info("Forgot password request for empId={}", empId);

        if (!dao.validateSecurityAnswers(empId, ans1, ans2)) {
            logger.warn("Security answer validation failed for empId={}", empId);
            throw new Exception("Security answers incorrect");
        }

        String tempPwd = PasswordGenerator.generateTempPassword();

        dao.resetPassword(empId, tempPwd);
        dao.savePasswordHistory(empId, tempPwd);

        logger.info("Password reset successful for empId={}, tempPwdGenerated=true", empId);
    }

    // ================= VIEW METHODS =================

    public void viewMyTeam(int managerId) throws Exception {
        logger.info("View team request for managerId={}", managerId);
        dao.viewMyTeam(managerId);
    }

    public void viewBirthdays() throws Exception {
