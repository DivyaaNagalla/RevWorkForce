package com.revworkforce.dao;

import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;

import com.revworkforce.model.Employee;
import com.revworkforce.util.DBUtil;

public class EmployeeDAO {
    public Employee login(int empId, String password) throws Exception {

        String sql =
            "SELECT EMP_ID, NAME, EMAIL, PHONE_NO, ADDRESS, EMERGENCY_CONTACT, " +
            "STATUS, MANAGER_ID " +
            "FROM EMPLOYEE WHERE EMP_ID=? AND PASSWORD=?";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, empId);
        ps.setString(2, password);

        ResultSet rs = ps.executeQuery();

        if (rs.next()) {
            Employee emp = new Employee();
            emp.setEmpId(rs.getInt("EMP_ID"));
            emp.setName(rs.getString("NAME"));
            emp.setEmail(rs.getString("EMAIL"));
            emp.setPhone(rs.getString("PHONE_NO"));
            emp.setAddress(rs.getString("ADDRESS"));
            emp.setEmergencyContact(rs.getString("EMERGENCY_CONTACT"));
            emp.setStatus(rs.getString("STATUS"));
            emp.setManagerId(rs.getInt("MANAGER_ID"));
            emp.setFirstLogin(rs.getString("FIRST_LOGIN"));

            return emp;
        }
        return null;
    }

    public void updatePassword(int empId, String newPwd) throws Exception {

        String sql =
            "UPDATE EMPLOYEE SET PASSWORD=?, FIRST_LOGIN='N' WHERE EMP_ID=?";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setString(1, newPwd);
        ps.setInt(2, empId);
        ps.executeUpdate();
    }
    public int addEmployee(String name,
                           String email,
                           String tempPwd) throws Exception {

        String sql =
            "INSERT INTO EMPLOYEE " +
            "(EMP_ID, NAME, EMAIL, PASSWORD, STATUS, FIRST_LOGIN) " +
            "VALUES (EMP_SEQ.NEXTVAL, ?, ?, ?, 'ACTIVE', 'Y')";

        Connection con = DBUtil.getConnection();

        PreparedStatement ps =
            con.prepareStatement(sql, new String[]{"EMP_ID"});

        ps.setString(1, name);
        ps.setString(2, email);
        ps.setString(3, tempPwd);
        ps.executeUpdate();

        ResultSet rs = ps.getGeneratedKeys();
        rs.next();
        return rs.getInt(1);
    }
    public void assignManager(int empId, int managerId) throws Exception {

        String sql =
            "UPDATE EMPLOYEE SET MANAGER_ID=? WHERE EMP_ID=?";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, managerId);
        ps.setInt(2, empId);
        ps.executeUpdate();
    }
    public void updateProfile(int empId,
                              String phone,
                              String address,
                              String emergency) throws Exception {

        String sql =
            "UPDATE EMPLOYEE " +
            "SET PHONE_NO=?, ADDRESS=?, EMERGENCY_CONTACT=? " +
            "WHERE EMP_ID=?";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setString(1, phone);
        ps.setString(2, address);
        ps.setString(3, emergency);
        ps.setInt(4, empId);
        ps.executeUpdate();
    }
    public void viewUpcomingBirthdays() throws Exception {

        String sql =
            "SELECT NAME, DOB FROM EMPLOYEE " +
            "WHERE TO_CHAR(DOB,'MMDD') >= TO_CHAR(SYSDATE,'MMDD') " +
            "ORDER BY TO_CHAR(DOB,'MMDD')";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ResultSet rs = ps.executeQuery();

        System.out.println("\n--- Upcoming Birthdays ---");
        while (rs.next()) {
            System.out.println(
                rs.getString(1) + " | " + rs.getDate(2)
            );
        }
    }
    public void viewWorkAnniversaries() throws Exception {

        String sql =
            "SELECT NAME, JOINING_DATE FROM EMPLOYEE " +
            "WHERE TO_CHAR(JOINING_DATE,'MMDD') = TO_CHAR(SYSDATE,'MMDD')";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ResultSet rs = ps.executeQuery();

        System.out.println("\n--- Work Anniversaries ---");
        while (rs.next()) {
            System.out.println(
                rs.getString(1) + " | " + rs.getDate(2)
            );
        }
    }
    public void viewEmployeeDirectory() throws Exception {

        String sql =
            "SELECT EMP_ID, NAME, EMAIL, PHONE_NO " +
            "FROM EMPLOYEE WHERE STATUS='ACTIVE'";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ResultSet rs = ps.executeQuery();

        System.out.println("\n--- Employee Directory ---");
        while (rs.next()) {
            System.out.println(
                rs.getInt(1) + " | " +
                rs.getString(2) + " | " +
                rs.getString(3) + " | " +
                rs.getString(4)
            );
        }
    }
}
