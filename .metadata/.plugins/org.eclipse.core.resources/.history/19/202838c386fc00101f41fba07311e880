package com.revworkforce.dao;

import java.sql.*;
import com.revworkforce.util.DBUtil;

public class PerformanceDAO {

    public int createReview(int empId, int year,
                            String del, String acc,
                            String imp, int rating) throws Exception {

        String sql =
          "INSERT INTO PERFORMANCE_REVIEW " +
          "(REVIEW_ID, EMP_ID, REVIEW_YEAR, DELIVERABLES, ACCOMPLISHMENTS, " +
          "IMPROVEMENTS, SELF_RATING, STATUS) " +
          "VALUES (REVIEW_SEQ.NEXTVAL, ?, ?, ?, ?, ?, ?, 'SUBMITTED')";

        PreparedStatement ps =
          DBUtil.getConnection().prepareStatement(sql, new String[]{"REVIEW_ID"});

        ps.setInt(1, empId);
        ps.setInt(2, year);
        ps.setString(3, del);
        ps.setString(4, acc);
        ps.setString(5, imp);
        ps.setInt(6, rating);

        ps.executeUpdate();
        ResultSet rs = ps.getGeneratedKeys();
        rs.next();
        return rs.getInt(1);
    }

    public void addGoal(int reviewId, String desc,
                        String priority, String metric) throws Exception {

        String sql =
          "INSERT INTO GOALS " +
          "(GOAL_ID, REVIEW_ID, DESCRIPTION, PRIORITY, SUCCESS_METRIC, PROGRESS, STATUS) " +
          "VALUES (GOAL_SEQ.NEXTVAL, ?, ?, ?, ?, 0, 'NOT_STARTED')";

        PreparedStatement ps =
          DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, reviewId);
        ps.setString(2, desc);
        ps.setString(3, priority);
        ps.setString(4, metric);

        ps.executeUpdate();
    }

    public void updateGoalProgress(int goalId, int progress) throws Exception {

        String status = progress == 100 ? "COMPLETED" : "IN_PROGRESS";

        String sql =
          "UPDATE GOALS SET PROGRESS=?, STATUS=? WHERE GOAL_ID=?";

        PreparedStatement ps =
          DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, progress);
        ps.setString(2, status);
        ps.setInt(3, goalId);

        ps.executeUpdate();
    }

    public void managerFeedback(int reviewId,
                                String feedback,
                                int rating) throws Exception {

        String sql =
          "UPDATE PERFORMANCE_REVIEW " +
          "SET MANAGER_FEEDBACK=?, MANAGER_RATING=?, STATUS='REVIEWED' " +
          "WHERE REVIEW_ID=?";

        PreparedStatement ps =
          DBUtil.getConnection().prepareStatement(sql);

        ps.setString(1, feedback);
        ps.setInt(2, rating);
        ps.setInt(3, reviewId);

        ps.executeUpdate();
    }
}
