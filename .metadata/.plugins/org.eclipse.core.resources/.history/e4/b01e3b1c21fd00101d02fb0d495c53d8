package com.revworkforce.dao;

import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Statement;

import com.revworkforce.model.Employee;
import com.revworkforce.util.DBUtil;

public class EmployeeDAO {

    // ================= LOGIN =================
    public Employee login(int empId, String password) throws Exception {

        String sql =
            "SELECT E.EMP_ID, E.NAME, E.EMAIL, E.STATUS, E.FIRST_LOGIN, " +
            "M.NAME AS MANAGER_NAME " +
            "FROM EMPLOYEE E LEFT JOIN EMPLOYEE M " +
            "ON E.MANAGER_ID = M.EMP_ID " +
            "WHERE E.EMP_ID=? AND E.PASSWORD=?";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, empId);
        ps.setString(2, password);

        ResultSet rs = ps.executeQuery();

        if (rs.next()) {
            Employee emp = new Employee();
            emp.setEmpId(rs.getInt("EMP_ID"));
            emp.setName(rs.getString("NAME"));
            emp.setEmail(rs.getString("EMAIL"));
            emp.setStatus(rs.getString("STATUS"));
            emp.setFirstLogin(rs.getString("FIRST_LOGIN"));
            emp.setManagerName(rs.getString("MANAGER_NAME"));
            return emp;
        }
        return null;
    }

    // ================= ADD EMPLOYEE =================
    public int addEmployee(String name,
                           String email,
                           Date dob,
                           String tempPwd) throws Exception {

        int empId = getNextEmpId();

        String sql =
            "INSERT INTO EMPLOYEE " +
            "(EMP_ID, NAME, EMAIL, DOB, JOIN_DATE, PASSWORD, FIRST_LOGIN, STATUS) " +
            "VALUES (?, ?, ?, ?, SYSDATE, ?, 'Y', 'ACTIVE')";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, empId);
        ps.setString(2, name);
        ps.setString(3, email);
        ps.setDate(4, dob);
        ps.setString(5, tempPwd);

        ps.executeUpdate();

        initializeLeaveBalance(empId);
        savePasswordHistory(empId, tempPwd);

        return empId;
    }

    // ================= AUTO LEAVE INIT =================
    public void initializeLeaveBalance(int empId) throws Exception {

        String sql =
            "INSERT INTO LEAVE_BALANCE (EMP_ID, LEAVE_TYPE_ID, AVAILABLE_DAYS) " +
            "SELECT ?, LEAVE_TYPE_ID, MAX_QUOTA FROM LEAVE_TYPE";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, empId);
        ps.executeUpdate();
    }

    // ================= UPDATE PASSWORD =================
    public void updatePassword(int empId, String newPwd) throws Exception {

        String sql =
            "UPDATE EMPLOYEE SET PASSWORD=?, FIRST_LOGIN='N' WHERE EMP_ID=?";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setString(1, newPwd);
        ps.setInt(2, empId);
        ps.executeUpdate();
    }

    // ================= PASSWORD HISTORY =================
    public boolean isPasswordUsedBefore(int empId, String pwd)
            throws Exception {

        String sql =
            "SELECT COUNT(*) FROM PASSWORD_HISTORY " +
            "WHERE EMP_ID=? AND PASSWORD=?";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, empId);
        ps.setString(2, pwd);

        ResultSet rs = ps.executeQuery();
        rs.next();

        return rs.getInt(1) > 0;
    }

    public void savePasswordHistory(int empId, String pwd)
            throws Exception {

        String sql =
            "INSERT INTO PASSWORD_HISTORY VALUES (?, ?, SYSDATE)";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, empId);
        ps.setString(2, pwd);
        ps.executeUpdate();
    }

    // ================= SECURITY QUESTIONS =================
    public void saveSecurityQuestions(int empId,
                                      String q1, String a1,
                                      String q2, String a2)
            throws Exception {

        String sql =
            "INSERT INTO EMP_SECURITY VALUES (?, ?, ?)";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, empId);
        ps.setString(2, q1);
        ps.setString(3, a1);
        ps.executeUpdate();

        ps.setInt(1, empId);
        ps.setString(2, q2);
        ps.setString(3, a2);
        ps.executeUpdate();
    }

    public boolean validateSecurityAnswers(int empId,
                                           String a1,
                                           String a2)
            throws Exception {

        String sql =
            "SELECT ANSWER FROM EMP_SECURITY WHERE EMP_ID=?";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setInt(1, empId);
        ResultSet rs = ps.executeQuery();

        int count = 0;

        while (rs.next()) {
            String ans = rs.getString("ANSWER");
            if (ans.equalsIgnoreCase(a1) ||
                ans.equalsIgnoreCase(a2)) {
                count++;
            }
        }

        return count == 2;
    }

    // ================= RESET PASSWORD =================
    public void resetPassword(int empId, String tempPwd)
            throws Exception {

        String sql =
            "UPDATE EMPLOYEE SET PASSWORD=?, FIRST_LOGIN='Y' WHERE EMP_ID=?";

        PreparedStatement ps =
            DBUtil.getConnection().prepareStatement(sql);

        ps.setString(1, tempPwd);
        ps.setInt(2, empId);
        ps.executeUpdate();
    }

    // ================= SEQUENCE =================
    private int getNextEmpId() throws Exception {

        String sql = "SELECT EMP_SEQ.NEXTVAL FROM DUAL";
        Statement st = DBUtil.getConnection().createStatement();
        ResultSet rs = st.executeQuery(sql);
        rs.next();
        return rs.getInt(1);
    }
}
